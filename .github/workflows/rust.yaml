# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
name: Rust & Sidekick
on: [push, pull_request, merge_group]
permissions:
  contents: read
jobs:
  test:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"
      - name: Display Go version
        run: go version
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Display Cargo version
        run: cargo version
      - name: Display rustc version
        run: rustup show active-toolchain -v
      - name: Install taplo
        run: |
          set -e
          curl -fsSL https://github.com/tamasfe/taplo/releases/download/$VERSION/taplo-linux-x86_64.gz | gunzip -c - | sudo tee /usr/local/bin/taplo > /dev/null
          sha512sum -c <(echo "$CHECKSUM /usr/local/bin/taplo")
          sudo chmod +x /usr/local/bin/taplo
          taplo --version
        env:
          VERSION: 0.10.0
          CHECKSUM: 33587a0beb692561b1bc411f484f088117b45d14e993cdb8e5d66dd967026d9e166ab8b23ec7c4791d1c17ec8bd9f1d6b05a16e742c70c6a6f16dc5f7ca3ff53
      - name: Install protoc
        run: |
          set -e
          curl -fsSL --retry 5 --retry-delay 15 -o /tmp/protoc.zip https://github.com/protocolbuffers/protobuf/releases/download/v$VERSION/protoc-$VERSION-linux-x86_64.zip
          sha512sum -c <(echo "$CHECKSUM /tmp/protoc.zip")
          cd /usr/local
          sudo unzip -o /tmp/protoc.zip
          protoc --version
        env:
          VERSION: 29.3
          CHECKSUM: f149c4a69910c8d241d27869d2cdf6791187a7a9434ad0f392b4a61e1697c3844e60bce634bd7147cb4cb7f2ad2530fc933be4976f67ac75d9ad78bb8b412f24
      - name: Verify git and tar are available
        run: |
          git --version
          tar --version
      - name: Run sidekick tests
        run: go test -race ./internal/sidekick/...
      - name: Run internal/librarian/internal/rust tests
        run: go test -race ./internal/librarian/internal/rust
